#!/usr/bin/env python3

#!/usr/bin/env python3
import click
import httpx


@click.group()
def cli():
    """A simple CLI tool for CoinGecko API"""
    pass


@cli.command()
@click.argument("name", default="bitcoin")
def price(name: str):
    """Fetch current price for a cryptocurrency (default: bitcoin)"""
    get_bitcoin_price(name)


@cli.command()
@click.option(
    "--limit", default=100000
)
def list(limit: int):
    """List available cryptocurrencies from CoinGecko"""
    url = "https://api.coingecko.com/api/v3/coins/list"
    try:
        response = httpx.get(url)
        response.raise_for_status()
        coins = response.json()
        for i, coin in enumerate(coins[:limit]):
            coin_id = coin["id"]
            symbol = coin["symbol"]
            name = coin["name"]
            print(f"{coin_id:<30} {symbol:<10} {name:<40}")
        total = len(coins)
        if limit < total:
            print(f"... (showing {limit} out of {total})")
    except httpx.HTTPError as e:
        click.echo(f"Error fetching coin list: {e}")
    except KeyError as e:
        click.echo(f"Error parsing data: {e}")


def get_bitcoin_price(name: str = "bitcoin"):
    """
    Fetch current price data from CoinGecko API
    """
    url = "https://api.coingecko.com/api/v3/simple/price"
    params = {
        "ids": name,
        "vs_currencies": "usd",
        "include_24hr_change": "true",
        "include_market_cap": "true",
        "include_24hr_vol": "true",
    }
    try:
        response = httpx.get(url, params=params)
        response.raise_for_status()
        data = response.json()
        coin_data = data.get(name.lower())
        if not coin_data:
            click.echo(f"Coin '{name}' not found.")
            return

        price = coin_data["usd"]

        click.echo(f"{price:,.2f}")

    except httpx.HTTPError as e:
        click.echo(f"Error fetching data: {e}")
    except KeyError as e:
        click.echo(f"Error parsing data: {e}")


if __name__ == "__main__":
    cli()
