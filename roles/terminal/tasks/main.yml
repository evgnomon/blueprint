---
- name: Gather OS specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}-{{ ansible_distribution_major_version}}.yml"
    - "{{ ansible_distribution }}.yml"
    - "{{ ansible_os_family}}.yml"
  tags:
    - always

- name: Inflate template configs
  include_tasks: j2_inflate.yaml
  when: item.state == 'file'
  with_filetree: ../templates

- name: Check profile picture exists
  stat:
    path: "{{ ansible_env.HOME }}/.ssh/.face"
  register: face_file_stat

- name: Set Gnome avatar
  shell: cp {{ ansible_env.HOME }}/.ssh/.face {{ ansible_env.HOME }}/.face
  args:
    creates: "{{ ansible_env.HOME }}/.face"
  when:
    - ansible_os_family == "Debian"
    - face_file_stat.stat.exists

- name: Install packages using Apt
  become: true
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
    name: "{{ apt_packages }}"
    state: present
  when: ansible_os_family == "Debian"
  tags:
    - apt

- name: Build fish shell
  include_tasks:
    file: fish-build.yml
  when: ansible_os_family == "Debian"

- name: Install common Cargo packages
  ansible.builtin.command:
    cmd: "{{ cargo_cmd }} install {{ item }}"
  loop: "{{ common_cargo_packages }}"

- name: Install OS specific Cargo packages
  ansible.builtin.command:
    cmd: "{{ cargo_cmd }} install {{ item }}"
  loop: "{{ cargo_packages | default ([]) }}"

- name: Install using MacPorts
  command: port -N install "{{ item }}"
  when: ansible_distribution == "MacOSX"
  with_items: "{{ macports_packages }}"
  tags:
    - macports

- name: Copy configs
  synchronize:
    src: "{{ item }}"
    dest: "{{ ansible_env.HOME }}"
  loop: "{{ dotfiles }}"
  tags:
    - dotfiles

- name: Install fonts
  include_tasks: fonts_install.yaml

- name: Update Pip packages for current user
  shell: pip install --upgrade {{ item }}
  with_items: "{{ common_pip_packages }}"
  tags:
    - pip

- name: Install common Go packages
  command: go install {{ item }}
  with_items: "{{ common_go_packages }}"

- name: Install common Node packages
  command: npm install -g {{ item }}
  with_items: "{{ common_node_packages }}"

- name: Clone Git repos
  shell: |
    mkdir -p '{{ repo_dest_dir }}'
    git clone {{ item.url }} '{{ repo_dest }}'
  args:
    creates: "{{ repo_dest }}/.git"
  vars: &git_repos_vars
    repo_hostname: "{{ item.url | urlsplit('hostname') }}"
    repo_path: "{{ item.url | urlsplit('path') | split('/') }}"
    repo_name: "{{ repo_path | last | regex_replace('\\.git$', '') }}"
    repo_parent: "{{ repo_path[1] }}"
    repo_prefix: "{{ item.prefix | default(ansible_env.HOME + '/src') }}"
    repo_rel_dest: "{{ repo_parent }}/{{ repo_name }}"
    repo_dest: "{{ repo_prefix }}/{{ repo_hostname }}/{{ item.rewrite | default( repo_rel_dest ) }}"
    repo_dest_dir: "{{ repo_dest | dirname }}"
    user_profile_key: "{{ item.profile | default('main') }}"
    user_profile: "{{ profiles[user_profile_key] }}"
  with_items: "{{ git_repos + common_git_repos }}"
  ignore_errors: true
  tags:
    - git

- name: Fetch Git repos
  shell: |
    git -C '{{ repo_dest }}' fetch --all
  vars: *git_repos_vars
  with_items: "{{ git_repos + common_git_repos }}"
  tags:
    - git

- name: Config git profiles
  shell: |
    git -C '{{ repo_dest }}' config user.email '{{ user_profile.useremail }}'
    git -C '{{ repo_dest }}' config user.name '{{ user_profile.fullname | default(user_profile.username) }}'
    git -C '{{ repo_dest }}' config user.signingKey '{{ profiles.main.gpg_key }}'
    git -C '{{ repo_dest }}' config commit.gpgsign true
  vars: *git_repos_vars
  with_items: "{{ git_repos + common_git_repos }}"
  ignore_errors: true
  tags:
    - git
